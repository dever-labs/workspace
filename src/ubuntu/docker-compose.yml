version: '3.8'

services:
  dev-desktop:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dev-desktop
    hostname: dev-desktop
    
    # Port mappings
    ports:
      - "3390:3389"  # RDP
      - "2222:22"    # SSH (if enabled)
    
    # Environment variables
    environment:
      - USERNAME=dev
      - PASSWORD=${DEV_PASSWORD:-dev}
      # - USER_UID=1000  # Uncomment to match your host UID
      # - USER_GID=1000  # Uncomment to match your host GID
      - ENABLE_SSH=false
      - TZ=${TIMEZONE:-America/New_York}
      - GIT_USER_NAME=${GIT_USER_NAME:-}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-}
    
    # Volumes for persistence
    volumes:
      # Persist home directory
      - dev-home:/home/dev
      # Shared workspace folder (Windows path example)
      - ${WORKSPACE_PATH:-./workspace}:/workspace
      # Docker socket for Docker-in-Docker (optional but useful)
      - /var/run/docker.sock:/var/run/docker.sock
      # SSH keys (optional - uncomment if you have SSH keys to mount)
      # - ${HOME}/.ssh:/run/secrets/ssh:ro
    
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    
    # Shared memory for better browser/app performance
    shm_size: '2gb'
    
    # Keep container running
    restart: unless-stopped
    
    # Security options
    # Privileged mode needed for Docker-in-Docker
    # Remove if you don't need nested containers
    # privileged: true
    
    # Alternative: Just add specific capabilities
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    
    # Health check
    healthcheck:
      test: ["CMD", "pgrep", "-x", "xrdp"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  dev-home:
    driver: local
